---
interface Props {
  title: string;
  slug: string;
  readingTime?: number;
}

const { title, slug, readingTime } = Astro.props;
---

<script is:inline>
  window['__onGCastApiAvailable'] = function(isAvailable) {
    if (isAvailable) {
      window.castAvailable = true;
      window.dispatchEvent(new Event('google-cast-available'));
    }
  };

  (function() {
    var script = document.createElement('script');
    script.src = 'https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1';
    script.async = true;
    document.body.appendChild(script);
  })();
</script>

<div class="tts-player-container flex items-center justify-center space-x-2 mt-4" data-title={title} data-slug={slug}>
  <button class="play-pause-tts p-2 rounded-full tts-button-style transition-colors duration-200" aria-label="Lancer la lecture" title="Lancer la lecture">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  </button>
  <button class="stop-tts p-2 rounded-full tts-stop-button-style transition-colors duration-200 hidden" aria-label="Arrêter la lecture" title="Arrêter la lecture">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
    </svg>
  </button>
  
  <a href={`/audio/${slug}.mp3`} target="_blank" aria-label="Écouter le fichier audio source" title="Écouter le fichier audio source" class="download-audio p-2 rounded-full tts-button-style transition-colors duration-200 flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
    </svg>
  </a>

  <select class="tts-speed p-2 rounded bg-stone-200 hover:bg-stone-300 text-stone-800 transition-colors duration-200 border-none text-sm cursor-pointer outline-none font-medium" aria-label="Vitesse de lecture">
    <option value="0.50">0.50x</option>
    <option value="0.75">0.75x</option>
    <option value="1" selected>1x</option>
    <option value="1.25">1.25x</option>
    <option value="1.5">1.5x</option>
    <option value="1.75">1.75x</option>
    <option value="2">2x</option>
    <option value="2.5">2.5x</option>
    <option value="2.75">2.75x</option>
    <option value="3">3x</option>
    <option value="3.5">3.5x</option>
    <option value="3.75">3.75x</option>
    <option value="4">4x</option>
  </select>
  {readingTime && (
    <span class="tts-reading-time text-xs font-sans font-bold uppercase tracking-widest text-stone-500" data-base-time={readingTime}>{readingTime} min</span>
  )}
</div>

<script>
  import { TTSController } from '../scripts/client/TTSController';

  function init() {
    document.querySelectorAll('.tts-player-container').forEach(container => {
        // Prevent double init
        if (container.hasAttribute('data-tts-initialized')) return;
        
        container.setAttribute('data-tts-initialized', 'true');
        
        new TTSController({
            container: container as HTMLElement,
            articleContentSelector: '.prose'
        });
    });
  }

  // Support View Transitions
  document.addEventListener('astro:page-load', init);
  // Fallback for first load if not using VT or if script runs late
  if (document.readyState !== 'loading') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
</script>
