---
import { getCollection } from 'astro:content';
import { format } from 'date-fns';
import { fr } from 'date-fns/locale';
import TTSPlayer from '../../components/TTSPlayer.astro';
import Layout from '../../layouts/Layout.astro';
import ArticleFloatingNav from '../../components/ArticleFloatingNav.astro';

export async function getStaticPaths() {
  const newsEntries = await getCollection('news');
  const sortedNews = newsEntries.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

  return sortedNews.map((entry, index) => ({
    params: { slug: entry.slug },
    props: {
      entry,
      nextPost: index - 1 >= 0 ? sortedNews[index - 1] : null,
      prevPost: index + 1 < sortedNews.length ? sortedNews[index + 1] : null,
    },
  }));
}

const { entry, nextPost, prevPost } = Astro.props;
const { Content } = await entry.render();

const formattedDate = format(entry.data.date, 'EEEE d MMMM yyyy à HH:mm', {
  locale: fr,
});

const wordsPerMinute = 200;
const words = entry.body.trim().split(/\s+/).length;
const readingTime = Math.ceil(words / wordsPerMinute);
---

<Layout title={entry.data.title}>
  <article class="mx-auto max-w-3xl" data-pagefind-body>
    <header
      class="mb-10 text-center border-b-4 border-double border-stone-300 pb-8"
    >
      <div
        class="flex flex-col items-center space-y-2 text-stone-600 font-sans text-sm uppercase tracking-widest"
      >
        <span class="text-2xl font-bold font-sans text-stone-600 uppercase tracking-wides" data-pagefind-meta="title">{formattedDate}</span>
      </div>
      <TTSPlayer title={entry.data.title} readingTime={readingTime} />
    </header>

    <div
      class="prose prose-stone prose-lg max-w-none mx-auto text-justify
      prose-headings:font-serif prose-headings:font-bold prose-headings:text-stone-900
      prose-p:font-serif prose-p:text-stone-800
      prose-a:text-stone-900 prose-a:underline prose-a:decoration-1 hover:prose-a:decoration-2 prose-a:font-normal prose-strong:text-base
      prose-blockquote:border-l-2 prose-blockquote:border-stone-900 prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:text-stone-700
      prose-img:border prose-img:border-stone-900 prose-img:p-1"
    >
      <Content />
    </div>

    <div
      class="mt-12 pt-8 border-t border-stone-900 flex flex-col gap-8 text-sm font-sans"
    >
      <nav
        class="flex flex-col sm:flex-row justify-between items-center gap-4 text-stone-900 font-bold uppercase tracking-widest"
      >
        {
          prevPost ? (
            <a
              href={`/news/${prevPost.slug}`}
              class="hover:underline text-center sm:text-left"
            >
              &larr; Précédent
            </a>
          ) : (
            <span class="w-20" />
          )
        }

        <a href="/" class="hover:underline text-center"> Retour à la Une </a>

        {
          nextPost ? (
            <a
              href={`/news/${nextPost.slug}`}
              class="hover:underline text-center sm:text-right"
            >
              Suivant &rarr;
            </a>
          ) : (
            <span class="w-20" />
          )
        }
      </nav>
    </div>
  </article>

  <ArticleFloatingNav />
</Layout>
