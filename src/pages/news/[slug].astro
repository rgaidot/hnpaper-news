---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { format } from 'date-fns';
import { fr } from 'date-fns/locale';
import TTSPlayer from '../../components/TTSPlayer.astro';

export async function getStaticPaths() {
  const newsEntries = await getCollection('news');
  const sortedNews = newsEntries.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

  return sortedNews.map((entry, index) => ({
    params: { slug: entry.slug },
    props: { 
      entry,
      nextPost: index - 1 >= 0 ? sortedNews[index - 1] : null,
      prevPost: index + 1 < sortedNews.length ? sortedNews[index + 1] : null,
    },
  }));
}

const { entry, nextPost, prevPost } = Astro.props;
const { Content } = await entry.render();

const formattedDate = format(entry.data.date, 'EEEE d MMMM yyyy à HH:mm', { locale: fr });

const wordsPerMinute = 200;
const words = entry.body.trim().split(/\s+/).length;
const readingTime = Math.ceil(words / wordsPerMinute);
---

<Layout title={entry.data.title}>
  <article class="mx-auto max-w-3xl">
    <!-- Header de l'article -->
    <header class="mb-10 text-center border-b-4 border-double border-stone-300 pb-8">
      <div class="flex flex-col items-center space-y-2 text-stone-600 font-sans text-sm uppercase tracking-widest">
        <span class="text-2xl font-bold">{formattedDate}</span>
        <span class="italic text-xs">Par {entry.data.author}</span>
      </div>
      <TTSPlayer title={entry.data.title} readingTime={readingTime} />
    </header>
    
    <!-- Contenu Markdown -->
    <div class="prose prose-stone prose-lg max-w-none mx-auto text-justify
      prose-headings:font-serif prose-headings:font-bold prose-headings:text-stone-900
      prose-p:font-serif prose-p:text-stone-800
      prose-a:text-stone-900 prose-a:underline prose-a:decoration-1 hover:prose-a:decoration-2
      prose-blockquote:border-l-2 prose-blockquote:border-stone-900 prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:text-stone-700
      prose-img:border prose-img:border-stone-900 prose-img:p-1
    ">
      <Content />
    </div>

    <!-- Liens Discussion & Source & Navigation -->
    <div class="mt-12 pt-8 border-t border-stone-900 flex flex-col gap-8 text-sm font-sans">
      <div class="space-y-1">
        {entry.data.discussionUrl && (
          <p>
            <strong>Discussion HN :</strong> <a href={entry.data.discussionUrl} target="_blank" rel="noopener noreferrer" class="text-stone-900 hover:underline">Participer</a>
          </p>
        )}
        {entry.data.sourceUrl && (
          <p>
            <strong>Source :</strong> <a href={entry.data.sourceUrl} target="_blank" rel="noopener noreferrer" class="text-stone-900 hover:underline">Lire l'original</a>
          </p>
        )}
      </div>
      
      <nav class="flex flex-col sm:flex-row justify-between items-center gap-4 text-stone-900 font-bold uppercase tracking-widest">
        {prevPost ? (
          <a href={`/news/${prevPost.slug}`} class="hover:underline text-center sm:text-left">
            &larr; Précédent
          </a>
        ) : (
          <span class="w-20"></span>
        )}

        <a href="/" class="hover:underline text-center">
          Retour à la Une
        </a>

        {nextPost ? (
          <a href={`/news/${nextPost.slug}`} class="hover:underline text-center sm:text-right">
            Suivant &rarr;
          </a>
        ) : (
          <span class="w-20"></span>
        )}
      </nav>
    </div>
  </article>

  <!-- Navigation intra-article (flottante) -->
  <div id="article-nav" class="fixed bottom-8 right-8 flex flex-col gap-2 opacity-0 transition-opacity duration-300 translate-y-4 pointer-events-none print:hidden">
    <button id="prev-section-btn" class="p-3 bg-stone-900 text-white rounded-full shadow-lg hover:bg-stone-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all pointer-events-auto" aria-label="Article précédent">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
      </svg>
    </button>
    
    <div class="flex items-center gap-2 pointer-events-auto bg-stone-900 rounded-full px-2 py-1 shadow-lg">
        <div id="section-indicator" class="text-white text-xs font-bold text-center font-sans min-w-[3rem]">
        <span id="current-section">1</span> / <span id="total-sections">1</span>
        </div>
        
        <button id="play-section-btn" class="p-2 text-white hover:bg-stone-700 rounded-full transition-all" aria-label="Lire cette section">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="play-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="pause-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
    </div>

    <button id="next-section-btn" class="p-3 bg-stone-900 text-white rounded-full shadow-lg hover:bg-stone-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all pointer-events-auto" aria-label="Article suivant">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </button>
  </div>

  <script>
    function initArticleNav() {
      const article = document.querySelector('.prose');
      if (!article) return;

      const navContainer = document.getElementById('article-nav');
      const prevBtn = document.getElementById('prev-section-btn');
      const nextBtn = document.getElementById('next-section-btn');
      const playBtn = document.getElementById('play-section-btn');
      const currentSpan = document.getElementById('current-section');
      const totalSpan = document.getElementById('total-sections');
      const playIcon = document.getElementById('play-icon');
      const pauseIcon = document.getElementById('pause-icon');

      if (!navContainer || !prevBtn || !nextBtn || !playBtn || !currentSpan || !totalSpan) return;

      // Identifier les sections basées sur les <hr>
      const hrs = Array.from(article.querySelectorAll('hr'));
      const sections = [];
      
      // Début de l'article
      sections.push({ top: article.getBoundingClientRect().top + window.scrollY, element: article.firstElementChild as HTMLElement });

      // Sections suivantes
      hrs.forEach(hr => {
        let nextEl = hr.nextElementSibling;
        while (nextEl && nextEl.tagName === 'HR') {
           nextEl = nextEl.nextElementSibling;
        }
        if (nextEl) {
          sections.push({ top: hr.getBoundingClientRect().top + window.scrollY, element: nextEl as HTMLElement });
        }
      });

      totalSpan.textContent = sections.length.toString();

      if (sections.length > 1) {
        navContainer.classList.remove('opacity-0', 'translate-y-4');
        navContainer.classList.add('opacity-100', 'translate-y-0');
      }

      let activeIndex = 0;

      const updateActiveSection = () => {
        const scrollY = window.scrollY;
        const offset = 200; 

        let newIndex = 0;
        for (let i = 0; i < sections.length; i++) {
            const elTop = sections[i].element ? (sections[i].element.getBoundingClientRect().top + window.scrollY) : sections[i].top;
            if (scrollY >= elTop - offset) {
                newIndex = i;
            } else {
                break;
            }
        }
        
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 50) {
            newIndex = sections.length - 1;
        }

        if (newIndex !== activeIndex) {
            activeIndex = newIndex;
            currentSpan.textContent = (activeIndex + 1).toString();
        }

        (prevBtn as HTMLButtonElement).disabled = activeIndex <= 0;
        (nextBtn as HTMLButtonElement).disabled = activeIndex >= sections.length - 1;
      };

      window.addEventListener('scroll', updateActiveSection, { passive: true });
      updateActiveSection();

      const scrollToSection = (index) => {
          if (index < 0 || index >= sections.length) return;
          const target = sections[index].element;
          if (target) {
              const headerOffset = 20; 
              const elementPosition = target.getBoundingClientRect().top;
              const offsetPosition = elementPosition + window.scrollY - headerOffset;

              window.scrollTo({
                  top: offsetPosition,
                  behavior: "smooth"
              });
          }
      };

      const playSection = (index) => {
          const ttsContainer = document.querySelector('.tts-player-container');
          if (!ttsContainer) return;
          if (index < 0 || index >= sections.length) return;
          
          const sectionEl = sections[index].element;
          if (sectionEl && (ttsContainer as any)._playFromElement) {
              (ttsContainer as any)._playFromElement(sectionEl);
          }
      };

      prevBtn.addEventListener('click', () => {
          const targetIndex = activeIndex - 1;
          scrollToSection(targetIndex);
          if (isPlaying) playSection(targetIndex);
      });

      nextBtn.addEventListener('click', () => {
          const targetIndex = activeIndex + 1;
          scrollToSection(targetIndex);
          if (isPlaying) playSection(targetIndex);
      });

      // TTS Control
      let isPlaying = false;

      // Listen to global TTS state
      window.addEventListener('tts-state-change', (e: any) => {
         const state = e.detail.state;
         isPlaying = state === 'playing';
         if (isPlaying) {
             playIcon?.classList.add('hidden');
             pauseIcon?.classList.remove('hidden');
         } else {
             playIcon?.classList.remove('hidden');
             pauseIcon?.classList.add('hidden');
         }
      });

      playBtn.addEventListener('click', () => {
          const ttsContainer = document.querySelector('.tts-player-container');
          if (!ttsContainer) return;

          if (isPlaying) {
              // Pause/Stop
              if ((ttsContainer as any)._togglePlay) {
                  (ttsContainer as any)._togglePlay();
              }
          } else {
              // Start playing current section
              const currentSectionEl = sections[activeIndex].element;
              if (currentSectionEl && (ttsContainer as any)._playFromElement) {
                  (ttsContainer as any)._playFromElement(currentSectionEl);
              } else if ((ttsContainer as any)._togglePlay) {
                  // Fallback
                  (ttsContainer as any)._togglePlay();
              }
          }
      });
    }

    document.addEventListener('astro:page-load', initArticleNav);
    document.addEventListener('DOMContentLoaded', initArticleNav);
  </script>
</Layout>
