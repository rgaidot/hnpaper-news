---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { format } from 'date-fns';
import { fr } from 'date-fns/locale';
import TTSPlayer from '../../components/TTSPlayer.astro';

export async function getStaticPaths() {
  const newsEntries = await getCollection('news');
  const sortedNews = newsEntries.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

  return sortedNews.map((entry, index) => ({
    params: { slug: entry.slug },
    props: { 
      entry,
      nextPost: index - 1 >= 0 ? sortedNews[index - 1] : null,
      prevPost: index + 1 < sortedNews.length ? sortedNews[index + 1] : null,
    },
  }));
}

const { entry, nextPost, prevPost } = Astro.props;
const { Content } = await entry.render();

const formattedDate = format(entry.data.date, 'EEEE d MMMM yyyy à HH:mm', { locale: fr });

const wordsPerMinute = 200;
const words = entry.body.trim().split(/\s+/).length;
const readingTime = Math.ceil(words / wordsPerMinute);
---

<Layout title={entry.data.title}>
  <article class="mx-auto max-w-3xl">
    <header class="mb-10 text-center border-b-4 border-double border-stone-300 pb-8">
      <div class="flex flex-col items-center space-y-2 text-stone-600 font-sans text-sm uppercase tracking-widest">
        <span class="text-2xl font-bold">{formattedDate}</span>
        <span class="italic text-xs">Par {entry.data.author}</span>
      </div>
      <TTSPlayer title={entry.data.title} readingTime={readingTime} />
    </header>
    
    <div class="prose prose-stone prose-lg max-w-none mx-auto text-justify
      prose-headings:font-serif prose-headings:font-bold prose-headings:text-stone-900
      prose-p:font-serif prose-p:text-stone-800
      prose-a:text-stone-900 prose-a:underline prose-a:decoration-1 hover:prose-a:decoration-2
      prose-blockquote:border-l-2 prose-blockquote:border-stone-900 prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:text-stone-700
      prose-img:border prose-img:border-stone-900 prose-img:p-1
    ">
      <Content />
    </div>

    <div class="mt-12 pt-8 border-t border-stone-900 flex flex-col gap-8 text-sm font-sans">
      <nav class="flex flex-col sm:flex-row justify-between items-center gap-4 text-stone-900 font-bold uppercase tracking-widest">
        {prevPost ? (
          <a href={`/news/${prevPost.slug}`} class="hover:underline text-center sm:text-left">
            &larr; Précédent
          </a>
        ) : (
          <span class="w-20"></span>
        )}

        <a href="/" class="hover:underline text-center">
          Retour à la Une
        </a>

        {nextPost ? (
          <a href={`/news/${nextPost.slug}`} class="hover:underline text-center sm:text-right">
            Suivant &rarr;
          </a>
        ) : (
          <span class="w-20"></span>
        )}
      </nav>
    </div>
  </article>

  <div id="article-nav" class="fixed bottom-8 right-8 flex flex-col items-end gap-2 opacity-0 transition-opacity duration-300 translate-y-4 pointer-events-none print:hidden">
    <div class="flex items-center pointer-events-auto bg-stone-900 rounded-full px-1.5 py-1 shadow-lg w-[10rem]">
      <button id="prev-section-btn" class="p-1.5 text-white hover:bg-stone-700 rounded-full disabled:opacity-30 disabled:cursor-not-allowed transition-all cursor-pointer" aria-label="Article précédent">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
      </button>

      <div id="section-indicator" class="text-white text-xs font-bold text-center font-sans flex-1 border-l border-r border-stone-700 mx-1">
        <span id="current-section">1</span> / <span id="total-sections">80</span>
      </div>

      <button id="next-section-btn" class="p-1.5 text-white hover:bg-stone-700 rounded-full disabled:opacity-30 disabled:cursor-not-allowed transition-all cursor-pointer" aria-label="Article suivant">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
    </div>
    
    <div class="flex items-center pointer-events-auto bg-stone-900 rounded-full px-1.5 py-1 shadow-lg w-[10rem]">
        <div class="relative group flex items-center justify-center">
            <button class="p-1.5 text-stone-400 hover:text-white transition-colors cursor-help rounded-full hover:bg-stone-700" aria-label="Raccourcis clavier">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
            <div class="absolute bottom-full right-0 mb-3 w-40 p-2.5 bg-stone-800 text-stone-200 text-xs rounded-lg shadow-xl opacity-0 invisible transition-all duration-200 transform translate-y-2 pointer-events-none group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 z-50 border border-stone-700 origin-bottom-right">
                 <div class="font-bold mb-1.5 text-white uppercase tracking-wider text-[9px] border-b border-stone-600 pb-1">Raccourcis</div>
                 <div class="grid grid-cols-[auto_1fr] gap-x-2.5 gap-y-1.5 items-center">
                     <div class="flex gap-1 justify-center">
                        <kbd class="bg-stone-600 px-1 py-0.5 rounded text-center min-w-[18px] font-mono text-white shadow-sm border-b border-stone-900 text-[10px]">←</kbd>
                        <kbd class="bg-stone-600 px-1 py-0.5 rounded text-center min-w-[18px] font-mono text-white shadow-sm border-b border-stone-900 text-[10px]">→</kbd>
                     </div>
                     <span class="text-[11px]">Naviguer</span>
                     
                     <div class="flex justify-center">
                        <kbd class="bg-stone-600 px-1.5 py-0.5 rounded text-center font-mono text-white shadow-sm border-b border-stone-900 text-[9px]">Espace</kbd>
                     </div>
                     <span class="text-[11px]">Lecture</span>
                 </div>
                 <div class="absolute -bottom-1 right-1.5 w-2 h-2 bg-stone-800 transform rotate-45 border-b border-r border-stone-700"></div>
            </div>
        </div>

        <div class="w-px h-5 bg-stone-700 mx-1"></div>

        <button id="floating-speed-btn" class="text-white text-xs font-bold hover:text-stone-300 transition-colors px-2 text-center font-sans hover:bg-stone-700 rounded-full py-1 flex-1" aria-label="Vitesse de lecture" title="Changer la vitesse">
            1x
        </button>
        
        <div class="w-px h-5 bg-stone-700 mx-1"></div>
        
        <button id="play-section-btn" class="p-1.5 text-white hover:bg-stone-700 rounded-full transition-all cursor-pointer" aria-label="Lire cette section">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="play-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="pause-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
    </div>
  </div>

  <script>
    function initArticleNav() {
      const article = document.querySelector('.prose');
      if (!article) return;

      const navContainer = document.getElementById('article-nav');
      const prevBtn = document.getElementById('prev-section-btn');
      const nextBtn = document.getElementById('next-section-btn');
      const playBtn = document.getElementById('play-section-btn');
      const currentSpan = document.getElementById('current-section');
      const totalSpan = document.getElementById('total-sections');
      const playIcon = document.getElementById('play-icon');
      const pauseIcon = document.getElementById('pause-icon');
      const speedBtn = document.getElementById('floating-speed-btn');

      if (!navContainer || !prevBtn || !nextBtn || !playBtn || !currentSpan || !totalSpan) return;

      const hrs = Array.from(article.querySelectorAll('hr'));
      const sections = [];
      
      sections.push({ top: article.getBoundingClientRect().top + window.scrollY, element: article.firstElementChild as HTMLElement });

      hrs.forEach(hr => {
        let nextEl = hr.nextElementSibling;
        while (nextEl && nextEl.tagName === 'HR') {
           nextEl = nextEl.nextElementSibling;
        }
        if (nextEl) {
          sections.push({ top: hr.getBoundingClientRect().top + window.scrollY, element: nextEl as HTMLElement });
        }
      });
      
      sections.forEach((section, index) => {
          if (!section.element) return;
          
          const sectionId = `section-${index + 1}`;
          section.element.id = sectionId;
          
          const anchorBtn = document.createElement('button');
          anchorBtn.className = 'group absolute -ml-8 mt-1 p-1 text-stone-400 hover:text-stone-900 transition-colors hidden sm:inline-flex items-center justify-center cursor-pointer';
          anchorBtn.setAttribute('aria-label', `Lien vers la section ${index + 1}`);
          anchorBtn.title = "Copier le lien de cette section";
          anchorBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
          `;
          
          if (getComputedStyle(section.element).position === 'static') {
            section.element.style.position = 'relative';
          }
          
          anchorBtn.addEventListener('click', (e) => {
              e.preventDefault();
              const url = new URL(window.location.href);
              url.hash = `#${sectionId}`;
              navigator.clipboard.writeText(url.toString()).then(() => {
                  const originalHTML = anchorBtn.innerHTML;
                  anchorBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                  `;
                  setTimeout(() => {
                      anchorBtn.innerHTML = originalHTML;
                  }, 2000);
              });
          });

          section.element.insertBefore(anchorBtn, section.element.firstChild);
      });

      totalSpan.textContent = sections.length.toString();

      if (sections.length > 1) {
        navContainer.classList.remove('opacity-0', 'translate-y-4');
        navContainer.classList.add('opacity-100', 'translate-y-0');
      }

      let activeIndex = 0;

      const updateActiveSection = () => {
        const scrollY = window.scrollY;
        const offset = 200; 

        let newIndex = 0;
        for (let i = 0; i < sections.length; i++) {
            const elTop = sections[i].element ? (sections[i].element.getBoundingClientRect().top + window.scrollY) : sections[i].top;
            if (scrollY >= elTop - offset) {
                newIndex = i;
            } else {
                break;
            }
        }
        
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 50) {
            newIndex = sections.length - 1;
        }

        if (newIndex !== activeIndex) {
            activeIndex = newIndex;
            currentSpan.textContent = (activeIndex + 1).toString();
        }

        (prevBtn as HTMLButtonElement).disabled = activeIndex <= 0;
        (nextBtn as HTMLButtonElement).disabled = activeIndex >= sections.length - 1;
      };

      window.addEventListener('scroll', updateActiveSection, { passive: true });
      updateActiveSection();

      const scrollToSection = (index) => {
          if (index < 0 || index >= sections.length) return;
          const target = sections[index].element;
          if (target) {
              const headerOffset = 20; 
              const elementPosition = target.getBoundingClientRect().top;
              const offsetPosition = elementPosition + window.scrollY - headerOffset;

              window.scrollTo({
                  top: offsetPosition,
                  behavior: "smooth"
              });
          }
      };
      
      if (window.location.hash) {
          const hash = window.location.hash.substring(1);
          const match = hash.match(/^section-(\d+)$/);
          if (match) {
              const index = parseInt(match[1], 10) - 1;
              setTimeout(() => scrollToSection(index), 100);
          }
      }

      const playSection = (index) => {
          const ttsContainer = document.querySelector('.tts-player-container');
          if (!ttsContainer) return;
          if (index < 0 || index >= sections.length) return;
          
          const sectionEl = sections[index].element;
          if (sectionEl && (ttsContainer as any)._playFromElement) {
              (ttsContainer as any)._playFromElement(sectionEl);
          }
      };

      prevBtn.addEventListener('click', () => {
          const targetIndex = activeIndex - 1;
          scrollToSection(targetIndex);
          if (isPlaying) playSection(targetIndex);
      });

      nextBtn.addEventListener('click', () => {
          const targetIndex = activeIndex + 1;
          scrollToSection(targetIndex);
          if (isPlaying) playSection(targetIndex);
      });

      document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey) return;

          const target = e.target as HTMLElement;
          if (target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'TEXTAREA') return;
          
          if (e.key === 'ArrowLeft') {
              const targetIndex = activeIndex - 1;
              if (targetIndex >= 0) {
                  scrollToSection(targetIndex);
                  playSection(targetIndex);
              }
          } else if (e.key === 'ArrowRight') {
              const targetIndex = activeIndex + 1;
              if (targetIndex < sections.length) {
                  scrollToSection(targetIndex);
                  playSection(targetIndex);
              }
          }
      });

      let isPlaying = false;

      window.addEventListener('tts-state-change', (e: any) => {
         const state = e.detail.state;
         isPlaying = state === 'playing';
         if (isPlaying) {
             playIcon?.classList.add('hidden');
             pauseIcon?.classList.remove('hidden');
         } else {
             playIcon?.classList.remove('hidden');
             pauseIcon?.classList.add('hidden');
         }
      });

      playBtn.addEventListener('click', () => {
          const ttsContainer = document.querySelector('.tts-player-container');
          if (!ttsContainer) return;

          if (isPlaying) {
              if ((ttsContainer as any)._togglePlay) {
                  (ttsContainer as any)._togglePlay();
              }
          } else {
              const currentSectionEl = sections[activeIndex].element;
              if (currentSectionEl && (ttsContainer as any)._playFromElement) {
                  (ttsContainer as any)._playFromElement(currentSectionEl);
              } else if ((ttsContainer as any)._togglePlay) {
                  (ttsContainer as any)._togglePlay();
              }
          }
      });

      if (speedBtn) {
        const ttsSpeedSelect = document.querySelector('.tts-speed') as HTMLSelectElement;
        
        const updateSpeedBtn = () => {
            if (ttsSpeedSelect) {
                const val = ttsSpeedSelect.value.replace('x', ''); 
                speedBtn.textContent = val + 'x';
            }
        };

        updateSpeedBtn();

        if (ttsSpeedSelect) {
            ttsSpeedSelect.addEventListener('change', updateSpeedBtn);
        }

        speedBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!ttsSpeedSelect) return;
            
            const currentSpeed = parseFloat(ttsSpeedSelect.value);
            const options = Array.from(ttsSpeedSelect.options).map(o => parseFloat(o.value));
            
            let nextIdx = options.findIndex(s => s > currentSpeed);
            if (nextIdx === -1) {
                nextIdx = 0;
            }
            
            const nextSpeed = options[nextIdx];
            ttsSpeedSelect.value = nextSpeed.toString();
            
            ttsSpeedSelect.dispatchEvent(new Event('change'));
            updateSpeedBtn();
        });
      }
    }

    document.addEventListener('astro:page-load', initArticleNav);
    document.addEventListener('DOMContentLoaded', initArticleNav);
  </script>
</Layout>
