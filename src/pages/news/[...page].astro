---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths({ paginate }) {
  const allNews = await getCollection('news');
  const sortedNews = allNews.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
  return paginate(sortedNews, { pageSize: 12 });
}

const { page } = Astro.props;

const getReadingTime = (body: string) => {
  const words = body.trim().split(/\s+/).length;
  return Math.ceil(words / 200);
};
---

<Layout title={`Archives - Page ${page.currentPage}`}>
  <div class="mb-12 border-b-4 border-double border-stone-300 pb-4 text-center">
    <h2
      class="text-2xl font-bold font-sans text-stone-600 uppercase tracking-widest"
    >
      Archives
    </h2>
    <span
      class="text-xs font-sans font-bold uppercase tracking-widest text-stone-500 mt-2 block"
      >Page {page.currentPage} sur {page.lastPage}</span
    >
  </div>

  <div class="grid gap-x-8 gap-y-12 sm:grid-cols-2 lg:grid-cols-3">
    {
      page.data.map((post) => (
        <article class="flex flex-col border-b border-stone-300 pb-8 sm:border-0 sm:pb-0">
          <div class="mb-2 text-lg font-bold tracking-widest text-stone-500 uppercase border-b border-stone-200 pb-1 flex justify-between w-full">
            <span>
              {new Date(post.data.date).toLocaleDateString("fr-FR", {
                day: "numeric",
                month: "long",
                year: "numeric",
              })}
            </span>
            <span>{getReadingTime(post.body)} min</span>
          </div>

          <p class="text-stone-700 font-serif text-base leading-relaxed mb-4 flex-grow line-clamp-4 text-justify">
            {post.body.split("---")[0]?.replace(/^#+\s/, "")}
          </p>

          <div class="mt-auto">
            <a
              href={`/news/${post.slug}`}
              class="text-base font-bold uppercase tracking-widest hover:underline text-stone-900"
            >
              Lire &rarr;
            </a>
          </div>
        </article>
      ))
    }
  </div>

  <nav
    class="flex justify-center items-center space-x-4 mt-16 font-serif pt-8 border-t border-stone-300"
  >
    {
      page.url.prev ? (
        <a
          href={page.url.prev}
          class="px-6 py-2 border border-stone-900 text-stone-900 font-bold hover:bg-stone-900 hover:text-white transition-colors uppercase text-sm tracking-widest"
        >
          &larr; Précédent
        </a>
      ) : (
        <span class="px-6 py-2 border border-stone-200 text-stone-300 uppercase text-sm tracking-widest cursor-not-allowed">
          &larr; Précédent
        </span>
      )
    }

    <div class="hidden sm:flex px-4 font-bold text-stone-900">
      Page {page.currentPage}
    </div>

    {
      page.url.next ? (
        <a
          href={page.url.next}
          class="px-6 py-2 border border-stone-900 text-stone-900 font-bold hover:bg-stone-900 hover:text-white transition-colors uppercase text-sm tracking-widest"
        >
          Suivant &rarr;
        </a>
      ) : (
        <span class="px-6 py-2 border border-stone-200 text-stone-300 uppercase text-sm tracking-widest cursor-not-allowed">
          Suivant &rarr;
        </span>
      )
    }
  </nav>
</Layout>
